{% extends '::base.html.twig' %}

{% block title %}
    {{ 'Project'|trans() }} {{ entity }} | {{ parent() }}
{% endblock %}

{% block sidebar %}
		{% if entity.status == '1' %}
				<p>
			    	<div class="progress progress-striped active">
				        <div class="progress-bar" role="progressbar" aria-valuenow="{{ entity.likesCount }}" aria-valuemin="0"
				             aria-valuemax="{{ entity.likesRequired }}"
				             style="width:{% if entity.likesCount == 0 %}0{% else %}{{ (entity.likesCount/entity.likesRequired) * 100 }}{% endif %}%">
				            <span class="sr-only">{% if entity.likesCount == 0 %}0{% else %}{{ (entity.likesCount/entity.likesRequired) * 100 }}{% endif %} {{ '% completed'|trans() }}</span>
				        </div>
				    </div>
				   	<strong><span class="likes_count">{{ entity.likesCount }}</span> {{ 'likes'|trans() }}</strong><br/>
		    		<strong>{{ entity.endingAt|time_remaining }}</strong>
		    </p>
		    {% if (is_granted('ROLE_USER') and app.user.id != entity.user.id) %}
		    <p>
		    		<a href="#" class="btn btn btn-success" id="likeProject">{{ 'I like this project'|trans() }}</a>
		    </p>
		    {% endif %}
		    <p class="lead">{{ 'Engagement evolution'|trans() }}</p>		 
		    <p>A FAIRE</p>   
		{% else %}
				<p>
				    <div class="progress progress-striped active">
				        <div class="progress-bar" role="progressbar" aria-valuenow="{{ entity.amountCount }}" aria-valuemin="0"
				             aria-valuemax="{{ entity.amountRequired }}"
				             style="width:{% if entity.amountCount == 0 %}0{% else %}{{ (entity.amountCount/entity.amountRequired) * 100 }}{% endif %}%">
				            <span class="sr-only">{% if entity.amountCount == 0 %}0{% else %}{{ (entity.amountCount/entity.amountRequired) * 100 }}{% endif %} {{ '€'|trans() }}</span>
				        </div>
				    </div>
				    <strong><span class="amount_count">{{ entity.amountCount }}</span> {{ '€ of'|trans() }} {{ entity.amountRequired }} {{ '€ required amount to raise'|trans() }}</strong><br/>
    				<strong>{{ entity.contributions|length }} {{ 'participants'|trans() }}</strong><br />
    				<strong>{{ entity.endingAt|time_remaining }}</strong>
    		</p>		
    		{% if (is_granted('ROLE_USER') and app.user.id != entity.user.id) %}
    				{{ form(funding_form, {attr:{role:'form' }}) }}
    		{% endif %}
		{% endif %}
		
		<hr class="clearfix" />
		
    <p>    
	    {{ 'Project realized by'|trans() }}<br />
	    
    	{% if entity.user.photo %}
	        <img src="{{ asset(entity.user.photo) }}" width="75">
	    {% else %}
	        <strong>{{ 'N/A'|trans() }}</strong>
	    {% endif %}
    
	    <strong>{{ entity.user }}</strong>
	    <small>{{ entity.user.city }}, {{ entity.user.country|country(app.request.locale) }}</small>
    </p>
    <p>
    		<a href="mailto:{{ entity.user.email }}">{{ 'Contact'|trans() }}</a>
    		<a href="{{ path('littlebigjoe_frontendbundle_user_show', {'id': entity.user.id}) }}">{{ 'Check his profile'|trans() }}</a>
    </p>   
    <p>
    		<a href="{{ path('littlebigjoe_frontendbundle_user_show', {'id': entity.user.id}) }}#projects">{{ 'His projects'|trans() }} ({{ entity.user.projects|length }} {{ 'realized projects'|trans() }})</a>
    </p> 
    
		<hr class="clearfix" />
		
		<p>
			<strong>{{ entity.brand }}</strong>	
			
			{% if entity.brand.logo %}
	        <img src="{{ asset(entity.brand.logo) }}" width="75">
	    {% else %}
	        <strong>{{ 'N/A'|trans() }}</strong>
	    {% endif %}
    
	    <ul>
	    {% for project in entity.brand.projects|reverse|slice(0, 4) %}
	        <li><a href="{{ path('littlebigjoe_frontendbundle_project_show', {'slug': project.slug}) }}">{{ project.name|e }}</a></li>
	    {% endfor %}	
	    </ul>
		</p>
		<p>
    		<a href="{{ path('littlebigjoe_frontendbundle_brand_show', {'slug': entity.brand.slug}) }}">{{ 'More projects from'|trans() }} {{ entity.brand }}</a>
    </p>
    
   	<hr class="clearfix" />
   			         		
    {% if entity.status != '1' %}
    	{% if entity.rewards %}
    		<ul>
     			{% for reward in entity.rewards %}
     				<li>
     					<p><strong>{{ reward.title }}</strong></p>
     					<p>{{ reward.stock }} {{ 'participants'|trans() }}</p>
     					<p>{{ reward.description }}</p>
     				</li>
     			{% endfor %}
    		</ul>
    	{% endif %}
    {% endif %}    
{% endblock %}

{% block body %}
    <h1>{{ 'Project'|trans() }} {{ entity }}</h1>
    {% if entity.status == '1' %}
        <span class="label label-primary">{{ 'Engagement phase'|trans() }}</span>
    {% else %}
        <span class="label label-success">{{ 'Funding phase'|trans() }}</span>
    {% endif %}
    <h2>
		    {{ entity.location }} - 
		    <a href="{{ path('littlebigjoe_backendbundle_categories_show', { 'id': entity.category.id }) }}">{{ entity.category }}</a>
		</h2>  
    <span class="label label-info">{{ 'Project default language :'|trans() }} {{ entity.language }}</span>
	
		<div class="clearfix">&nbsp;</div>

		<ul class="nav nav-tabs" id="projectTab">
	      <li class="active"><a data-toggle="tab" href="#project">{{ 'Project'|trans() }}</a></li>
	      <li><a data-toggle="tab" href="#news">{{ 'News'|trans() }}</a></li>
	      <li><a data-toggle="tab" href="#participants">{{ 'Participants'|trans() }}</a></li>
      	<li><a data-toggle="tab" href="#comments">{{ 'Comments'|trans() }}</a></li>
    </ul>

		<div id="projectTabContent" class="tab-content">
				<div id="project" class="tab-pane in active">
						<div class="clearfix">&nbsp;</div>
          	<div class="col-sm-6 col-md-3 pull-left">
		            <a href="#" class="thumbnail text-center">
		                {% if entity.photo %}
		                    <img src="{{ asset(entity.photo) }}">
		                {% else %}
		                    <strong>{{ 'N/A'|trans() }}</strong>
		                {% endif %}
		            </a>
		        </div>
		        <p class="lead">{{ entity.pitch }}</p>
		         {{ entity.description|raw() }}
        </div>
        <div id="news" class="tab-pane">
        		<div class="clearfix">&nbsp;</div>
          	<p class="lead">{{ 'Here\'s the list of news related to'|trans() }} {{ entity }} {{ 'project'|trans() }}</p>
          	
          	{% if is_granted('ROLE_USER') and app.user.id == entity.user.id %}
          	<div style="padding:20px;border:1px dotted black">
          		<h4>{{ 'Add new entry'|trans() }}</h4>
          		{{ form(entry_form, {attr:{role:'form' }}) }}
          	</div>
          	{% endif %}
          	
          	{% if entity.entries %}
          			{% set users_ids = [] %}
          			{% if entity.contributions %}
          					{% for contribution in entity.contributions %}
          							{% if contribution.user.id not in users_ids %}
          									{% set users_ids = users_ids|merge([contribution.user.id]) %}
          							{% endif %}
          					{% endfor %}
          			{% endif %}
          			
          			<ul>
          			{% for entry in entity.entries|reverse %}
          					{% if (is_granted('ROLE_USER') and app.user.id == entity.user.id) or (entry.isPublic) or (is_granted('ROLE_USER') and app.user.id in users_ids) %}
          					<li>
          							<strong>{{ entry }} {% if entry.isPublic %}{{ '(Public)'|trans() }}{% else %}{{ '(Private)'|trans() }}{% endif %}</strong><br />
          							<small>{{ 'On'|trans() }} {{ entry.createdAt|date('d/m/Y h:i') }}</small><br />
          							<p>{{ entry.content|raw }}</p>
          					</li>
          					{% endif %}
          			{% endfor %}
          			</ul>
          	{% else %}
          			<p><strong>{{ 'There\'s no news for the moment'|trans() }}</strong><p>
          	{% endif %}
        </div>
        <div id="participants" class="tab-pane">
        		<div class="clearfix">&nbsp;</div>
          	<p class="lead">{{ 'Here\'s the list of persons that have funded'|trans() }} {{ entity }} {{ 'project'|trans() }}</p>
          	{% if entity.contributions %}
          			{% set users_ids = [] %}
          			<ul>
          			{% for contribution in entity.contributions %}
          					{% if contribution.user.id not in users_ids %}
          							{% set users_ids = users_ids|merge([contribution.user.id]) %}
          							<li><a href="{{ path('littlebigjoe_frontendbundle_user_show', {'id': contribution.user.id}) }}">{{ contribution.user }}</a></li>
          					{% endif %}
          			{% endfor %}
          			</ul>
          	{% else %}
          			<p><strong>{{ 'There\'s no participants for the moment'|trans() }}</strong><p>
          	{% endif %}
        </div>
        <div id="comments" class="tab-pane">
        		<div class="clearfix">&nbsp;</div>
          	<p class="lead">{{ 'Here\'s the list of comments related to'|trans() }} {{ entity }} {{ 'project'|trans() }}</p> 
          	{% if entity.entries %}
          			{% for entry in entity.entries %}
          					{% if entry.comments %}
		          					<ul>          			
		          					{% for comment in entry.comments %}
				          					<li>
				          							<strong><a href="{{ path('littlebigjoe_frontendbundle_user_show', {'id': comment.user.id}) }}">{{ comment.user }}</a></strong><br />
				          							<small>{{ 'On'|trans() }} {{ comment.createdAt|date('d/m/Y h:i') }}</small><br />
				          							<p>{{ comment.content }}</p>
				          					</li>
				          			{% endfor %}
				          			</ul>
		          			{% endif %}
		          	{% endfor %}
		        {% else %}
          			<p><strong>{{ 'There\'s no comments for the moment'|trans() }}</strong><p>
          	{% endif %}         	
        </div>
		</div>
{% endblock %}

{% block footer_javascripts %}
		{{ parent() }}
		<script type="text/javascript">
				var currentProjectId = {{ entity.id }};
				$(document).ready(function () {
	        	// Project tabs
	        	$('#projectTab a').click(function (e) {
								e.preventDefault();
								$(this).tab('show');
						});
	        	
	        	// Like request
	        	$('#likeProject').click(function (e) {
		        		$.post("{{ path('littlebigjoe_frontendbundle_ajax_like_project') }}", { 'projectId' : currentProjectId })
			        	.done(function(data) { 
		        				if (data.status == 'OK')
		        				{
		        						alert("{{ 'Thanks for liking the project !'|trans() }}"); 	
		        						var likes = parseInt($('.likes_count').text()) + 1;
		        						$('.likes_count').text(likes);
		        				}
		        				else if (data.status == 'KO USER')
		        				{
		        						window.location = "{{ path('fos_user_security_login') }}";
		        				}
		        				else if (data.status == 'KO VOTE')
		        				{
		        						alert("{{ 'You already have liked this project !'|trans() }}"); 	
		        				}
		        				else
		        				{
		        						alert("{{ 'An error has occured during project liking. Please try again'|trans() }}"); 
		        				} 
		        		});
	        	});
				});
		</script>
{% endblock %}
