{% extends '::base.html.twig' %}

{% block title %}
    {{ 'User'|trans() }} {{ entity }} | {{ parent() }}
{% endblock %}

{% block sidebar %}{% endblock %}

{% block body %}
    <h2>{{ 'User'|trans() }} {{ entity }}</h2>

    {% if entity.facebookUrl %}<a href="{{ entity.facebookUrl }}">{{ 'Facebook URL'|trans() }}</a>{% endif %}
    {% if entity.twitterUrl %}<a href="{{ entity.twitterUrl }}">{{ 'Twitter URL'|trans() }}</a>{% endif %}
    {% if entity.googleUrl %}<a href="{{ entity.googleUrl }}">{{ 'Google URL'|trans() }}</a>{% endif %}

    {% set show_follow_button = true %}
            
    {% if (is_granted('ROLE_USER') and app.user.id != entity.id) %}            
        {% for follower in entity.followers %}
            {% if app.user.id == follower.id %}
                {% set show_follow_button = false %}
            {% endif %}
        {% endfor %}
    {% endif %}    

    {% if (is_granted('ROLE_USER') and app.user.id != entity.id) or (is_granted('IS_AUTHENTICATED_ANONYMOUSLY') and not is_granted('ROLE_USER')) %}
    <div id="followBox" {% if show_follow_button != true %}style="display:none"{% endif %}>
        <a id="followUser" class="btn btn btn-success" href="#">{{ 'Follow'|trans() }}</a>            
    </div>
    
    <div id="unfollowBox" {% if show_follow_button %}style="display:none"{% endif %}>
        <a id="currentFollowUser" class="btn btn btn-info" href="#">{{ 'Followed'|trans() }}</a>
        <a id="unfollowUser" class="btn btn btn-danger" href="#" style="display:none">{{ 'Unfollow'|trans() }}</a>            
    </div>  
    {% endif %}

    <div class="clearfix">&nbsp;</div>
    {% if entity.websiteUrl %}<a href="{{ entity.websiteUrl }}">{{ entity.websiteUrl }}</a>{% endif %}
    <div class="clearfix">&nbsp;</div>

    {% if entity.photo %}
        <img src="{{ asset(entity.photo) }}" width="250">
    {% else %}
        <strong>{{ 'N/A'|trans() }}</strong>
    {% endif %}

    <h2>{{ 'Biography'|trans() }}</h2>
    <p>{{ entity.bio }}</p>

    <div class="clearfix">&nbsp;</div>
     		
    <h2 id="projects">{{ 'His projects'|trans() }}</h2>    
    {% if entity.projects|length > 0 %}   
        {% for project in entity.projects %}
            {% if project.photo %}
                <img src="{{ asset(project.photo) }}" width="200" height="200">
            {% else %}
                <strong>{{ 'No image'|trans() }}</strong>
            {% endif %}

            {% if project.brand.logo %}
                <img src="{{ asset(project.brand.logo) }}" width="50" height="50">
            {% endif %}

            <h3>
                <a href="{{ path('littlebigjoe_frontendbundle_project_show', {'slug': project.slug}) }}">{{ project.name }}</a>
            </h3>
            {% if project.status == '1' %}
                <span class="label label-primary">{{ 'Engagement phase'|trans() }}</span>
            {% else %}
                <span class="label label-success">{{ 'Funding phase'|trans() }}</span>
            {% endif %}

            <p>{{ project.pitch }}</p>
            <p>
                <a href="{{ path('littlebigjoe_frontendbundle_category_show', {'slug': project.category.slug}) }}">{{ project.category }}</a>
            </p>

            {% if project.status == '1' %}
                <p>
                    <strong>{{ project.likesCount }}</strong> {{ 'likes'|trans() }} |
                    {% if project.likesCount == 0 %}
                        0
                    {% elseif ((project.likesCount/project.likesRequired) * 100) > 100 %}
                        100
                    {% else %}
                        {{ ((project.likesCount/project.likesRequired) * 100)|number_format(1, '.', ',') }}
                    {% endif %} %
                </p>
            {% else %}
                <p>
                    {% if project.amountCount == 0 %}
                        0
                    {% elseif ((project.amountCount/project.amountRequired) * 100) > 100 %}
                        100
                    {% else %}
                        {{ ((project.amountCount/project.amountRequired) * 100)|number_format(1, '.', ',') }}
                    {% endif %} % |
                    <strong>{{ project.amountCount }}</strong>{{ '€'|trans() }} |
                    {{ project.endingAt|time_remaining }}
                </p>
            {% endif %}
        {% endfor %}
    {% else %}
    		<p>{{ 'There\'s no projects for the moment'|trans() }}</p>
    {% endif %}
    
    <div class="clearfix">&nbsp;</div>
    
    <h2 id="projects_contributions">{{ 'Projects in which the user has participated'|trans() }}</h2>    
    {% if distinctProjects|length > 0 %}  
        {% for project in distinctProjects %}
            {% if project.photo %}
                <img src="{{ asset(project.photo) }}" width="200" height="200">
            {% else %}
                <strong>{{ 'No image'|trans() }}</strong>
            {% endif %}

            {% if project.brand.logo %}
                <img src="{{ asset(project.brand.logo) }}" width="50" height="50">
            {% endif %}

            <h3>
                <a href="{{ path('littlebigjoe_frontendbundle_project_show', {'slug': project.slug}) }}">{{ project.name }}</a>
            </h3>
            {% if project.status == '1' %}
                <span class="label label-primary">{{ 'Engagement phase'|trans() }}</span>
            {% else %}
                <span class="label label-success">{{ 'Funding phase'|trans() }}</span>
            {% endif %}

            <p>{{ project.pitch }}</p>
            <p>
                <a href="{{ path('littlebigjoe_frontendbundle_category_show', {'slug': project.category.slug}) }}">{{ project.category }}</a>
            </p>

            {% if project.status == '1' %}
                <p>
                    <strong>{{ project.likesCount }}</strong> {{ 'likes'|trans() }} |
                    {% if project.likesCount == 0 %}
                        0
                    {% elseif ((project.likesCount/project.likesRequired) * 100) > 100 %}
                        100
                    {% else %}
                        {{ ((project.likesCount/project.likesRequired) * 100)|number_format(1, '.', ',') }}
                    {% endif %} %
                </p>
            {% else %}
                <p>
                    {% if project.amountCount == 0 %}
                        0
                    {% elseif ((project.amountCount/project.amountRequired) * 100) > 100 %}
                        100
                    {% else %}
                        {{ ((project.amountCount/project.amountRequired) * 100)|number_format(1, '.', ',') }}
                    {% endif %} % |
                    <strong>{{ project.amountCount }}</strong>{{ '€'|trans() }} |
                    {{ project.endingAt|time_remaining }}
                </p>
            {% endif %}
        {% endfor %}
    {% else %}
    		<p>{{ 'There\'s no projects for the moment'|trans() }}</p>
    {% endif %}
{% endblock %}

{% block footer_javascripts %}
	{{ parent() }}
	<script type="text/javascript">
	    var currentUserId = {{ entity.id }};
	    $(document).ready(function () {                
	        // Follow request 
	        $('#followUser').click(function (e) {
	           $.post("{{ path('littlebigjoe_frontendbundle_ajax_follow_user') }}", { 'userId' : currentUserId })
	           .done(function(data) { 
	                   if (data.status == 'OK')
	                   {
	                           alert("{{ 'Thanks for follow this user !'|trans() }}");   
	                           $('#followBox').hide();
	                           $('#unfollowBox').show();
	                   }
	                   else if (data.status == 'KO USER')
	                   {
	                           window.location = "{{ path('fos_user_security_login') }}";
	                   }
	                   else if (data.status == 'KO FOLLOW')
	                   {
	                           alert("{{ 'You already have followed this user !'|trans() }}");     
	                   }
	                   else
	                   {
	                           alert("{{ 'An error has occured during user follow. Please try again'|trans() }}"); 
	                   } 
	           });
	        });
	        
	        // Hover
            $('#unfollowBox').hover(function(e){
                $('#currentFollowUser').hide();
                $('#unfollowUser').show();
            }, function(e){
                $('#unfollowUser').hide();
                $('#currentFollowUser').show();
            });
	        
	        // Unfollow request 
	           $('#unfollowUser').click(function (e) {
	              $.post("{{ path('littlebigjoe_frontendbundle_ajax_unfollow_user') }}", { 'userId' : currentUserId })
	              .done(function(data) { 
	                      if (data.status == 'OK')
	                      {
	                              alert("{{ 'Thanks for unfollow this user !'|trans() }}");   
	                              $('#unfollowBox').hide();
	                              $('#followBox').show();
	                      }
	                      else if (data.status == 'KO USER')
	                      {
	                              window.location = "{{ path('fos_user_security_login') }}";
	                      }
	                      else if (data.status == 'KO UNFOLLOW')
	                      {
	                              alert("{{ 'You already have unfollowed this user !'|trans() }}");     
	                      }
	                      else
	                      {
	                              alert("{{ 'An error has occured during user unfollow. Please try again'|trans() }}"); 
	                      } 
	              });
	           });
	     });
	</script>
{% endblock %}